generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["extendedWhereUnique"]
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id            String    @id @default(cuid())
  /// 用户名称
  name          String?
  /// 用户邮箱
  email         String    @unique
  /// 是否验证功能
  emailVerified DateTime? @map("email_verified")
  /// 用户头像
  image         String?
  /// 用户密码
  password      String?
  accounts      Account[]
  credit        Decimal   @default(0) @db.Decimal(9, 1)

  @@map("users")
}

enum AccountType {
  oauth
  email
  credentials
}

model Account {
  id                String      @id @default(cuid())
  userId            String      @map("user_id")
  provider          String
  providerAccountId String      @map("provider_account_id")
  refreshToken      String?     @map("refresh_token")
  accessToken       String?     @map("access_token") @db.Text
  expiresAt         Int?        @map("expires_at")
  tokenType         String?     @map("token_type")
  scope             String?
  type              AccountType
  idToken           String?     @map("id_token") @db.Text
  sessionState      String?     @map("session_state")
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String                @unique
  type       VerificationTokenType
  createdAt  DateTime              @default(now()) @map("created_at")
  expires    DateTime
  usedAt     DateTime?             @map("used_at")

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum CreditType {
  SIGN
  PURCHASE
  TASK
}

model CreditHistory {
  id        BigInt     @id @default(autoincrement())
  userId    String     @map("user_id") /// 用户id
  amount    Decimal    @db.Decimal(9, 1) /// 消耗数量
  type      CreditType // 消耗类型
  happendAt DateTime   @default(now()) ///发生时间

  @@map("credit_histories")
}

model CreditGood {
  id          BigInt  @id @default(autoincrement())
  name        String ///名称
  description String? @db.Text
  credits     Decimal @db.Decimal(9, 1) ///点数
  price       Decimal @db.Decimal(9, 0) ///价钱(分)
  actived     Boolean ///是否可用

  @@map("credit_goods")
}

enum CreditPayStatus {
  PAYING
  SUCCESS
  FAILED
}

model CreditPayHistory {
  id         BigInt          @id @default(autoincrement())
  userId     String          @map("user_id")
  payNo      String          @unique @map("pay_no")
  fee        Decimal         @db.Decimal(9, 0)
  goodId     BigInt          @map("good_id")
  createdAt  DateTime        @default(now()) @map("created_at")
  finishedAt DateTime?
  status     CreditPayStatus

  @@map("credit_pay_histories")
}

model Task {
  id       BigInt   @id @default(autoincrement())
  /// 用户ID
  userId   String   @map("user_id")
  /// PDF hash
  pdfHash  String   @map("pdf_hash")
  /// 语言
  language String
  /// 任务类型
  type     TaskType

  pages       Int
  /// 页数
  costCredits Decimal @default(0) @map("cost_credits") @db.Decimal(9, 1)
  /// 消耗credits

  state      TaskState
  /// 创建时间
  createdAt  DateTime  @default(now()) @map("created_at")
  /// 结束时间
  finishedAt DateTime? @map("finished_at")
  summary    Summary?  @relation(fields: [pdfHash, language], references: [pdfHash, language])

  @@index([pdfHash, language, type])
  @@map("tasks")
}

model Summary {
  id                  BigInt     @id @default(autoincrement())
  pdfHash             String     @map("pdf_hash")
  /// PDF hash
  language            String?
  /// 语言
  title               String?
  /// 标题
  shortTitle          String     @map("short_title")
  /// 简写标题
  titleZh             String     @map("title_zh")
  /// 中文标题
  basicInfo           String     @map("basic_info") @db.Text
  /// 基础内容
  briefIntroduction   String     @map("brief_introduction") @db.Text
  /// 简短的总结，采用json
  firstPageConclusion String     @map("first_page_conclusion") @db.Text
  /// 第一页总结内容
  content             String     @db.Text
  /// 全部总结内容
  mediumContent       String     @map("medium_content") @db.Text
  /// 中等总结内容
  shortContent        String     @map("short_content") @db.Text
  /// 简短总结内容
  createdAt           DateTime   @map("create_time")
  ///  创建时间
  tasks               Task[]
  paperInfo           PaperInfo? @relation(fields: [pdfHash], references: [pdfHash])

  @@unique([pdfHash, language])
  @@map("summaries")
}

/// 关键词库
model Keywords {
  id                String              @id @default(cuid())
  /// 关键词缩写
  keywordShort      String              @map("keyword_short")
  /// 关键词原文
  searchKeywords    String              @unique @map("search_keywords")
  /// 订阅量
  subNum            Int                 @map("sub_num")
  createTime        DateTime?           @map("create_time")
  updateTime        DateTime?           @map("update_time") @db.Timestamp(0)
  subscribeKeywords SubscribeKeywords[]
  keywordsPdf       KeywordsPdf[]

  @@map("keyword_subscribe_table")
}

/// 关键词与pdf 关联中间表
model KeywordsPdf {
  id             String    @id @default(cuid())
  /// 关键词
  searchKeywords String    @map("search_keywords")
  /// 查询来源
  searchFrom     String    @map("search_From")
  /// 对应文献pdfurl
  pdfUrl         String    @map("pdf_url")
  keywords       Keywords? @relation(fields: [searchKeywords], references: [searchKeywords])

  @@unique([searchKeywords, pdfUrl])
  @@map("search_keywords_pdf")
}

///   用户订阅关键词表
model SubscribeKeywords {
  id           String    @id @default(cuid())
  /// 关键词
  weChatUserId String    @map("we_chat_user_id")
  /// 对应文献pdfurl
  keywordId    String    @map("keyword_id")
  // / 用户openId
  openId       String    @map("open_id")
  // 关键词详情
  keywords     Keywords? @relation(fields: [keywordId], references: [id])

  @@unique([weChatUserId, keywordId])
  @@index([weChatUserId, keywordId])
  @@map("subscribe_keywords")
}

/// paper预览图库
model PaperImage {
  id             String @id @default(cuid())
  /// 关键词
  searchKeywords String @map("search_keywords")
  /// 预览图路径
  imgUrl         String @map("img_url")

  @@map("keywords_img_table")
}

/// 文献基础信息表
model PaperInfo {
  id              String            @id @default(cuid())
  /// paper的简介链
  url             String?
  /// 对应文献pdfurl
  pdfUrl          String            @unique @map("pdf_url")
  /// pdf hash值
  pdfHash         String            @unique @map("pdf_hash")
  /// 年份可以更具体一点，具体到天
  year            Int?
  /// 标题
  title           String?
  /// 代码链接
  code            String?           @db.Text
  /// 文章引用doi
  doi             String?
  /// 相关联的doi
  relatedDoi      String            @map("related_doi")
  /// 被引用链接
  citedByUrl      String            @map("cited_by_url")
  /// 作者
  authors         String?
  /// 摘要
  abstract        String            @db.Text
  /// 预览图
  imgUrl          String?           @map("img_url")
  /// 发表时间
  pubTime         DateTime?         @map("pub_time")
  /// paper内的keywords
  paperKeywords   String            @map("paper_keywords")
  ///  创建时间
  createTime      DateTime?         @map("create_time")
  summary         Summary[]
  favoriteDetails FavoriteDetails[]
  wxLike          Wxlike[]
  wxWaitRead      WxWaitRead[]

  @@map("subscribe_paper_info")
}

/// 待阅
model WxWaitRead {
  id           String     @id @default(cuid())
  ///  微信用户编号
  weChatUserId String     @map("we_chat_user_id")
  /// 微信用户 openid
  openId       String     @map("open_id")
  ///  待阅文章主键
  paperId      String?
  ///  创建时间
  createTime   DateTime?  @map("create_time")
  paperInfo    PaperInfo? @relation(fields: [paperId], references: [id])

  @@map("wx_wait_read")
}

/// 收藏夹
model Favorite {
  id              String            @id @default(cuid())
  ///  微信用户编号
  weChatUserId    String            @map("we_chat_user_id")
  /// 微信用户 openid
  openId          String            @map("open_id")
  ///  收藏夹名称
  name            String?
  ///  创建时间
  createTime      DateTime?         @map("create_time")
  updateTime      DateTime?         @map("update_time") @db.Timestamp(0)
  /// 收藏夹内容
  favoriteDetails FavoriteDetails[]

  @@map("favorite")
}

/// 收藏夹内容
model FavoriteDetails {
  id           String     @id @default(cuid())
  /// 微信用户编号
  weChatUserId String     @map("we_chat_user_id")
  /// 微信用户 openid
  openId       String     @map("open_id")
  /// 收藏夹主键
  favoriteId   String?    @map("favorite_id")
  /// 文章主键
  paperId      String?    @map("paper_id")
  /// 收藏来源
  source       String?
  /// 创建时间
  createTime   DateTime?  @map("create_time")
  updateTime   DateTime?  @map("update_time") @db.Timestamp(0)
  favorite     Favorite?  @relation(fields: [favoriteId], references: [id])
  paperInfo    PaperInfo? @relation(fields: [paperId], references: [id])

  @@map("favorite_detail")
}

/// 点赞
model Wxlike {
  id           String     @id @default(cuid())
  ///  微信用户编号
  weChatUserId String     @map("we_chat_user_id")
  /// 微信用户 openid
  openId       String     @map("open_id")
  ///  点赞文章主键
  paperId      String?
  ///  创建时间
  createTime   DateTime?  @map("create_time")
  paperInfo    PaperInfo? @relation(fields: [paperId], references: [id])

  @@map("wx_like")
}

/// 微信用户表
model WxUser {
  id          String    @id @default(cuid())
  openId      String    @unique @map("open_id")
  unionId     String    @unique @map("union_id")
  nickName    String?   @map("nick_name")
  phone       String    @unique
  email       String?
  avatar      String?
  country     String?
  province    String?
  city        String?
  birthday    String?
  educational String?
  gender      String?
  interest    String?
  intro       String?
  createTime  DateTime? @map("create_time")
  updateTime  DateTime? @map("update_time") @db.Timestamp(0)

  @@map("wx_users")
}

enum VerificationTokenType {
  register
  reset_password
}

enum TaskState {
  /// 正在运行
  RUNNING
  /// 成功
  SUCCESS
  /// 失败
  FAIL
}

enum TaskType {
  /// 总结
  SUMMARY
  /// 翻译
  TRANSLATE
}

enum accounts_type {
  oauth
  email
  credentials
}
